<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Variable Swapper</title>
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Variable Swapper BETA</h1>
      <p class="subtitle">Swap variables on imported components to local variables</p>
    </header>

    <div id="loading" class="loading hidden">
      <div class="spinner"></div>
      <p id="loading-text">Analyzing component...</p>
    </div>

    <div id="error" class="error hidden">
      <div class="error-icon">‚ö†Ô∏è</div>
      <p id="error-message"></p>
    </div>

    <div id="main-content" class="main-content">
      <div class="action-section">
        <button id="analyze-btn" class="button primary">
          <span class="button-icon">üîç</span>
          Analyze selected component
        </button>
        <div style="height: 0.75rem;"></div>
        <button id="swap-all-btn" class="button primary hidden" disabled>
          <span class="button-icon">üîÑ</span>
          Swap instances and variables
        </button>
        <div id="inline-loading" class="inline-loading hidden">
          <div class="spinner sm"></div>
          <span id="inline-loading-text">Analyzing component...</span>
        </div>
      </div>

      <div id="content-panel" class="content-panel hidden">
        <!-- This panel will show either analysis results or success message -->
        <div id="analysis-content" class="analysis-content">
          <div class="summary-section">
            <div class="summary-card">
              <div class="summary-icon">üìä</div>
              <div class="summary-content">
                <h3>Analysis completed for <span id="component-name"></span></h3>
                <p id="summary-text">Found <span id="variable-count">0</span> variables and <span id="external-count">0</span> external instance(s)</p>
              </div>
            </div>
          </div>

          <div class="actions">
            <button id="swap-all-btn" class="button primary hidden" disabled>
              <span class="button-icon">üîÑ</span>
              Swap instances and variables
            </button>
          </div>
        </div>

        <div id="success-content" class="success-content hidden">
          <div class="success-icon">‚úÖ</div>
          <h3>Variables swapped!</h3>
          <p id="success-message"></p>
          <div id="error-list" class="error-list hidden"></div>
        </div>
      </div>
    </div>
  </div>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 0.875rem;
      line-height: 1.4;
      color: var(--figma-color-text);
      background: var(--figma-color-bg);
    }

    .container {
      padding: 1rem;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .header {
      margin-bottom: 1.5rem;
    }

    .header h1 {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--figma-color-text);
    }

    .subtitle {
      color: var(--figma-color-text-secondary);
      font-size: 0.8125rem;
    }

    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      flex: 1;
      text-align: center;
    }

    .spinner {
      width: 2rem;
      height: 2rem;
      border: 2px solid var(--figma-color-border);
      border-top: 2px solid var(--figma-color-text);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    .spinner.sm {
      width: 2rem;
      height: 2rem;
      margin-bottom: 0.5rem;
      margin-right: 0;
      display: block;
    }

    .inline-loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      margin-top: 0.75rem;
      color: var(--figma-color-text-secondary);
      font-size: 0.8125rem;
      width: 100%;
      text-align: center;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .error {
      display: flex;
      align-items: center;
      padding: 1rem;
      background: var(--figma-color-bg-danger);
      border: 1px solid var(--figma-color-border-danger);
      border-radius: 0.375rem;
      margin-bottom: 1rem;
    }

    .error-icon {
      font-size: 1.25rem;
      margin-right: 0.75rem;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .action-section {
      margin-bottom: 1.5rem;
    }

    .button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem 1rem;
      border: 1px solid var(--figma-color-border);
      border-radius: 0.375rem;
      font-size: 0.8125rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s ease;
      text-decoration: none;
      background: var(--figma-color-bg);
      color: var(--figma-color-text);
      width: 100%;
    }

    .button:hover:not(:disabled) {
      background: var(--figma-color-bg-hover);
    }

    .button:active:not(:disabled) {
      background: var(--figma-color-bg-pressed);
    }

    .button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .button.primary {
      background: var(--figma-color-bg-brand);
      color: var(--figma-color-text-onbrand);
      border-color: var(--figma-color-border-brand);
    }

    .button.primary:hover:not(:disabled) {
      background: var(--figma-color-bg-brand-hover);
    }

    .button.secondary {
      background: var(--figma-color-bg-secondary);
      color: var(--figma-color-text-secondary);
    }

    .button-icon {
      margin-right: 0.5rem;
    }

    .content-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .analysis-content {
      display: flex;
      flex-direction: column;
    }

    .success-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-height: 6rem;
    }

    .component-info {
      margin-bottom: 1.5rem;
      padding: 1rem;
      background: var(--figma-color-bg-secondary);
      border-radius: 0.375rem;
    }

    .component-info h2 {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .component-type {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      background: var(--figma-color-bg-tertiary);
      border-radius: 0.25rem;
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      color: var(--figma-color-text-secondary);
    }

    .component-details {
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: var(--figma-color-bg-tertiary);
      border-radius: 0.25rem;
      font-size: 0.75rem;
      color: var(--figma-color-text-secondary);
    }

    .summary-section {
      margin-bottom: 1.5rem;
    }

    .summary-card {
      display: flex;
      align-items: center;
      padding: 1rem;
      background: var(--figma-color-bg-secondary);
      border: 1px solid var(--figma-color-border);
      border-radius: 0.375rem;
    }

    .summary-icon {
      font-size: 1.5rem;
      margin-right: 1rem;
    }

    .summary-content h3 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }

    .summary-content p {
      font-size: 0.8125rem;
      color: var(--figma-color-text-secondary);
    }

    #variable-count {
      font-weight: 600;
      color: var(--figma-color-text);
    }

    .actions {
      display: flex;
      gap: 0.75rem;
    }

    .actions .button {
      flex: 1;
    }

    .success-icon {
      font-size: 2rem;
      margin-bottom: 1rem;
    }

    .success-content h3 {
      font-size: 1.125rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .success-content p {
      color: var(--figma-color-text-secondary);
      margin-bottom: 1.5rem;
    }

    .error-list {
      width: 100%;
      max-width: 100%;
      text-align: left;
      margin-top: 1rem;
    }

    .error-list h4 {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--figma-color-text);
    }

    .error-list ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .error-list li {
      padding: 0.5rem;
      margin-bottom: 0.25rem;
      border: 1px solid var(--figma-color-border-danger);
      border-radius: 0.25rem;
      font-size: 0.8125rem;
      color: var(--figma-color-text);
      word-wrap: break-word;
    }

    .error-list li:not(:first-child) {
      margin-top: 0.75rem;
    }

    .hidden {
      display: none !important;
    }
  </style>

  <script>
    let variableMatches = [];

    // UI elements
    const loadingEl = document.getElementById('loading');
    const errorEl = document.getElementById('error');
    const errorMessageEl = document.getElementById('error-message');
    const mainContentEl = document.getElementById('main-content');
    const contentPanelEl = document.getElementById('content-panel');
    const analysisContentEl = document.getElementById('analysis-content');
    const successContentEl = document.getElementById('success-content');
    const successMessageEl = document.getElementById('success-message');
    const errorListEl = document.getElementById('error-list');
    const componentNameEl = document.getElementById('component-name');
    const variableCountEl = document.getElementById('variable-count');
    
    const loadingTextEl = document.getElementById('loading-text');
    const swapAllBtnEl = document.getElementById('swap-all-btn');
    const externalCountEl = document.getElementById('external-count');
    const inlineLoadingEl = document.getElementById('inline-loading');
    const inlineLoadingTextEl = document.getElementById('inline-loading-text');

    // Buttons
    const analyzeBtnEl = document.getElementById('analyze-btn');

    // Event listeners
    analyzeBtnEl.addEventListener('click', analyzeSelection);
    swapAllBtnEl.addEventListener('click', swapInstancesAndVariables);

    // Listen to messages from plugin
    window.onmessage = (event) => {
      const msg = event.data.pluginMessage;
      
      if (msg.type === 'error') {
        showError(msg.message);
      } else if (msg.type === 'analysis-complete') {
        showResults(msg);
      } else if (msg.type === 'swap-complete') {
        showSuccess(msg);
      } else if (msg.type === 'combined-swap-complete') {
        showExternalSwapResult(msg);
      }
    };

    function analyzeSelection() {
      // Reset everything to ensure a fresh start
      resetUI();
      showLoading('Analyzing component...');
      parent.postMessage({ pluginMessage: { type: 'analyze-selection' } }, '*');
    }

    function swapInstancesAndVariables() {
      showLoading('Swapping instances and variables...');
      parent.postMessage({ pluginMessage: { type: 'swap-instances-and-variables' } }, '*');
    }

    function cancel() {
      parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*');
    }

    function showLoading(text = 'Working...') {
      // keep buttons in place, only hide content panel/error
      contentPanelEl.classList.add('hidden');
      errorEl.classList.add('hidden');
      inlineLoadingTextEl.textContent = text;
      inlineLoadingEl.classList.remove('hidden');
      // prevent double clicks
      analyzeBtnEl.disabled = true;
      swapAllBtnEl.disabled = true;
      swapAllBtnEl.classList.add('hidden');
    }

    function showError(message) {
      hideAll();
      errorMessageEl.textContent = message;
      errorEl.classList.remove('hidden');
    }

    function showResults(data) {
      hideAll();
      
      variableMatches = data.variableMatches || [];
      componentNameEl.textContent = data.componentName || 'Unknown component';
      
      // Count number of variables that can be swapped
      const swappableCount = variableMatches.filter(match => 
        match.localVariable !== null || match.localTextStyle !== null
      ).length;
      
      variableCountEl.textContent = swappableCount;
      if (typeof data.externalCount === 'number') {
        externalCountEl.textContent = data.externalCount;
      }
      
      // Enable combined swap if either we have variables to swap or external instances
      const enableCombined = (swappableCount > 0) || ((data.externalCount || 0) > 0);
      swapAllBtnEl.disabled = !enableCombined;
      if (enableCombined) {
        swapAllBtnEl.classList.remove('hidden');
      } else {
        swapAllBtnEl.classList.add('hidden');
      }
      
      // Show analysis content
      analysisContentEl.classList.remove('hidden');
      successContentEl.classList.add('hidden');
      inlineLoadingEl.classList.add('hidden');
      analyzeBtnEl.disabled = false;
      contentPanelEl.classList.remove('hidden');
    }

    function showExternalInstances(data) {
      hideAll();
      const count = data.count || 0;
      externalCountEl.textContent = count;
      contentPanelEl.classList.remove('hidden');
    }

    function showExternalSwapResult(data) {
      hideAll();
      const swapped = data.swappedCount || 0;
      const attempted = data.attemptedCount || 0;
      const varSwapped = data.variableSwapped || 0;
      const varAttempted = data.variableAttempted || 0;
      const failures = Array.isArray(data.failures) ? data.failures : [];
      
      // Set success message
      const instText = `Swapped ${swapped}/${attempted} external instance${attempted !== 1 ? 's' : ''}`;
      const varText = varAttempted > 0 ? ` and ${varSwapped}/${varAttempted} variable${varAttempted !== 1 ? 's' : ''}` : '';
      successMessageEl.textContent = `${instText}${varText}.`;
      
      if (failures.length > 0) {
        errorListEl.innerHTML = '';
        const ul = document.createElement('ul');
        failures.slice(0, 20).forEach(err => {
          const li = document.createElement('li');
          li.textContent = err;
          ul.appendChild(li);
        });
        errorListEl.appendChild(ul);
        errorListEl.classList.remove('hidden');
      } else {
        errorListEl.classList.add('hidden');
      }
      
      // Show success content
      analysisContentEl.classList.add('hidden');
      successContentEl.classList.remove('hidden');
      inlineLoadingEl.classList.add('hidden');
      analyzeBtnEl.disabled = false;
      swapAllBtnEl.disabled = true;
      contentPanelEl.classList.remove('hidden');
    }

    function showSuccess(data) {
      hideAll();
      
      const { successCount, errorCount, errors, errorGroups } = data;
      let message = `Swapped ${successCount} variable${successCount !== 1 ? 's' : ''}.`;
      
      if (errorCount > 0) {
        message += ` ${errorCount} error${errorCount !== 1 ? 's' : ''} occurred.`;
      }
      
      successMessageEl.textContent = message;
      
      // Show error list if there are errors
      if (errorCount > 0) {
        errorListEl.innerHTML = '';
        
        // Check if there are any instance override errors
        const hasInstanceOverrideErrors = checkForInstanceOverrideErrors(errorGroups, errors);
        const instanceNodeNames = getInstanceOverrideNodeNames(errorGroups, errors);
        
        // If groups are sent from plugin, show summarized list
        if (Array.isArray(errorGroups) && errorGroups.length > 0) {
          const errorList = document.createElement('ul');
          
          // Add special message for instance override errors
          if (hasInstanceOverrideErrors) {
            const instanceLi = document.createElement('li');
            const namesSuffix = Array.isArray(instanceNodeNames) && instanceNodeNames.length > 0
              ? `<br/>Check that these are connected to the correct library: "${instanceNodeNames.join(', ')}"`
              : '';
            instanceLi.innerHTML = `
              <strong>üí° Tip:</strong> Some variables cannot be overridden because they are bound to instances from the original library. 
              Consider swapping these instances with versions from your local library.${namesSuffix}
            `;
            instanceLi.style.background = 'var(--figma-color-bg-secondary)';
            instanceLi.style.color = 'var(--figma-color-text-onbrand)';
            instanceLi.style.border = '1px solid var(--figma-color-border)';
            errorList.appendChild(instanceLi);
          }
          
          errorGroups.forEach(group => {
            const li = document.createElement('li');
            li.textContent = `${group.count}√ó ${group.message}`;
            errorList.appendChild(li);
          });
          errorListEl.appendChild(errorList);
        } else if (errors.length > 0) {
          // fallback to raw list
          const errorList = document.createElement('ul');
          
          // Add special message for instance override errors
          if (hasInstanceOverrideErrors) {
            const instanceLi = document.createElement('li');
            const namesSuffix = Array.isArray(instanceNodeNames) && instanceNodeNames.length > 0
              ? `<br/>Check that these are connected to the correct library: "${instanceNodeNames.join(', ')}"`
              : '';
            instanceLi.innerHTML = `
              <strong>üí° Tip:</strong> Some variables cannot be overridden because they are bound to instances from the original library. 
              Consider swapping these instances with versions from your local library.${namesSuffix}
            `;
            instanceLi.style.background = 'var(--figma-color-bg-brand)';
            instanceLi.style.color = 'var(--figma-color-text-onbrand)';
            instanceLi.style.border = '1px solid var(--figma-color-border-brand)';
            errorList.appendChild(instanceLi);
          }
          
          errors.forEach(error => {
            const li = document.createElement('li');
            li.textContent = error;
            errorList.appendChild(li);
          });
          errorListEl.appendChild(errorList);
        }
        
        errorListEl.classList.remove('hidden');
      } else {
        errorListEl.classList.add('hidden');
      }
      
      // Show success content
      analysisContentEl.classList.add('hidden');
      successContentEl.classList.remove('hidden');
      inlineLoadingEl.classList.add('hidden');
      analyzeBtnEl.disabled = false;
      swapAllBtnEl.disabled = true;
      contentPanelEl.classList.remove('hidden');
    }
    
    // Helper function to check if there are instance override errors
    function checkForInstanceOverrideErrors(errorGroups, errors) {
      // Check error groups first
      if (Array.isArray(errorGroups) && errorGroups.length > 0) {
        return errorGroups.some(group => 
          group.message && group.message.includes('Variable cannot be overridden in instance (not exposed)')
        );
      }
      
      // Fallback to check individual errors
      if (Array.isArray(errors) && errors.length > 0) {
        return errors.some(error => 
          error && error.includes('Variable cannot be overridden in instance (not exposed)')
        );
      }
      
      return false;
    }

    // Helper to extract unique node names from instance override errors
    function getInstanceOverrideNodeNames(errorGroups, errors) {
      const names = new Set();
      const pattern = /Swapping failed for .* on (.*?): Variable cannot be overridden in instance \(not exposed\)/;

      if (Array.isArray(errorGroups) && errorGroups.length > 0) {
        errorGroups.forEach(group => {
          if (group && typeof group.message === 'string') {
            const match = group.message.match(pattern);
            if (match && match[1]) names.add(match[1]);
          }
        });
      }

      if (Array.isArray(errors) && errors.length > 0) {
        errors.forEach(err => {
          if (typeof err === 'string') {
            const match = err.match(pattern);
            if (match && match[1]) names.add(match[1]);
          }
        });
      }

      return Array.from(names);
    }


    function resetUI() {
      // Reset all UI elements to their initial state
      hideAll();
      
      // Reset button states
      analyzeBtnEl.disabled = false;
      swapAllBtnEl.disabled = true;
      swapAllBtnEl.classList.add('hidden');
      
      // Clear any content that might be lingering
      errorListEl.innerHTML = '';
      errorListEl.classList.add('hidden');
      
      // Reset variable matches
      variableMatches = [];
      
      // Reset text content
      componentNameEl.textContent = '';
      variableCountEl.textContent = '0';
      externalCountEl.textContent = '0';
      successMessageEl.textContent = '';
      errorMessageEl.textContent = '';
    }

    function hideAll() {
      loadingEl.classList.add('hidden');
      errorEl.classList.add('hidden');
      contentPanelEl.classList.add('hidden');
      inlineLoadingEl.classList.add('hidden');
    }
  </script>
</body>
</html>

